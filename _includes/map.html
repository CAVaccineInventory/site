<script type="module">
  import {
    getHasVaccine,
    getDisplayableVaccineInfo,
  } from "./assets/js/data.js";

  // Initialize and populate the map
  function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: window.searchLocation ? 10 : 6,
      center: window.searchLocation || { lng: -119.335893, lat: 37.25967 },
      mapTypeControl: false,
      streetViewControl: false,
    });

    function shouldUseSpecialPin(info) {
      return info.isSuperSite === true;
    }

    function addLocation(p) {
      if (!getHasVaccine(p)) {
        return false;
      }

      let info = getDisplayableVaccineInfo(p);

      if (!info.latitude || !info.longitude) {
        console.log(`Missing lat/lon for ${info.name}!!`);
        return false;
      }

      // Format the info card
      let infoText = `<h1 class="text-green-600">${info.name}</h1>`;

      if (info.isSuperSite) {
        infoText += '<b class="text-lg supersite-tag">Super Site</b> <br />';
      }

      infoText += `<b>Details: </b> ${info.status}<br/>`;

      if (info.schedulingInstructions) {
        infoText += `<b>Appointment information: </b> ${info.schedulingInstructions} <br />`;
      }
      if (info.address) {
        infoText += `<b>Address:</b> ${info.address}<br />`;
      }
      if (info.reportNotes) {
        infoText += `<b>Latest info:</b> ${info.reportNotes}<br />`;
      }

      // Populate the marker and info card
      const markerConfig = {
        position: {
          lng: info.longitude,
          lat: info.latitude,
        },
        map: map,
        title: info.name,
      };

      const bluePin = "/assets/img/blue-pin.png";
      if (shouldUseSpecialPin(info)) {
        markerConfig["icon"] = bluePin;
      }
      let marker = new google.maps.Marker(markerConfig);
      let infowindow = new google.maps.InfoWindow({
        content: `<div class="mapInfo">${infoText}</div>`,
      });

      // Toggle the info card
      marker.addListener("click", () => {
        if (prev_infowindow) {
          prev_infowindow.close();
        }

        if (prev_infowindow == infowindow) {
          prev_infowindow = false;
        } else {
          infowindow.open(map, marker);
          prev_infowindow = infowindow;
        }
      });
    }

    // Pull the JSON blob of locations for the map
    let request = new XMLHttpRequest();
    request.open(
      "GET",
      "https://storage.googleapis.com/cavaccineinventory-sitedata/airtable-sync/Locations.json"
    );
    request.responseType = "json";
    request.onload = function () {
      request.response.map((p) => addLocation(p));
    };
    request.send();
    window.locationsMap = map;
  }

  // State tracking for info cards
  var prev_infowindow = false;
  window.initMap = initMap;
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLgxtP80D9RxICUGicbeZf29_qUii9_sk&callback=initMap&libraries=&v=weekly"
  defer
></script>
<div id="map" class="h-full w-full"></div>