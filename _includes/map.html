<script type="module">
    import {getHasVaccine, getDisplayableVaccineInfo} from "./assets/js/data.js";

    // Initialize and populate the map
    function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 6,
            center: { lng: -119.335893, lat: 37.259670 },
            mapTypeControl: false,
            streetViewControl: false,
        });



        function addLocation(p) {
            if (!getHasVaccine(p)) {
                return false
            }

            let info = getDisplayableVaccineInfo(p);

            // Format the info card
            let infoText = "<h1>" + info.name + "</h1>" + "<b>Details: </b> " + info.status + "<br />";

            if (info.schedulingInstructions) {
                infoText += "<b>Appointment information: </b>" + info.schedulingInstructions + "<br />"
            }
            if (info.address) {
                infoText += "<b>Address:</b> " + info.address + "<br />";
            }
            if (info.locationNotes) {
                infoText += "<b>Location notes:</b> " + info.locationNotes + "<br />";
            }
            if (info.reportNotes) {
                infoText += "<b>Latest info:</b> " + info.reportNotes + "<br />";
            }

            // Populate the marker and info card
            let marker = new google.maps.Marker({ position: { lng: info.longitude, lat: info.latitude}, map: map, title: info.name })
            let infowindow = new google.maps.InfoWindow({ content: infoText });

            // Toggle the info card
            marker.addListener("click", () => {
                if (prev_infowindow) {
                    prev_infowindow.close();
                }

                if (prev_infowindow == infowindow) {
                    prev_infowindow = false
                } else {
                    infowindow.open(map, marker);
                    prev_infowindow = infowindow
                }
            });
        }

        // Pull the JSON blob of locations for the map
        let request = new XMLHttpRequest();
        request.open('GET', 'https://storage.googleapis.com/cavaccineinventory-sitedata/airtable-sync/Locations.json');
        request.responseType = 'json'
        request.onload = function () { request.response.map(p => addLocation(p)) };
        request.send()
    }

    // State tracking for info cards
    var prev_infowindow = false;
    window.initMap = initMap;
</script>

<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLgxtP80D9RxICUGicbeZf29_qUii9_sk&callback=initMap&libraries=&v=weekly"
    defer></script>
<div class="h-72 md:h-96 lg:h-full">
    <div id='map' class="h-full w-full"></div>
</div>
